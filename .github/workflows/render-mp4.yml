name: Render HTML to 4K MP4

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Puppeteer & FFmpeg
      run: |
        npm init -y
        npm install puppeteer
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Render frames in 4K vertical
      run: |
        mkdir frames
        node << 'EOF'
        const puppeteer = require("puppeteer");
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        (async () => {
          const browser = await puppeteer.launch({
            headless: "new",
            args: ["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-gpu"]
          });

          const page = await browser.newPage();
          await page.setViewport({
            width: 2160,
            height: 3840,
            deviceScaleFactor: 2
          });

          await page.goto("file://" + process.cwd() + "/index.html", { waitUntil: "networkidle0" });
          await sleep(1000);

          const frames = 600; // 10 detik @60fps
          for (let i = 0; i < frames; i++) {
            await page.screenshot({
              path: `frames/frame_${String(i).padStart(4, "0")}.png`
            });
            await sleep(16); // ~60fps
          }

          await browser.close();
        })();
        EOF

    - name: Convert frames to MP4 with audio
      run: |
        ffmpeg -y -framerate 60 -i frames/frame_%04d.png \
        -i https://cdn.pixabay.com/download/audio/2023/06/19/audio_17b4e5aa1f.mp3?filename=calm-study-ambient-128.mp3 \
        -c:v libx264 -profile:v high -level 5.1 -pix_fmt yuv420p \
        -c:a aac -b:a 192k -shortest \
        -movflags +faststart \
        output_4k.mp4

    - name: Upload MP4
      uses: actions/upload-artifact@v4
      with:
        name: tiktok-video-4k
        path: output_4k.mp4
