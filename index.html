<script>
const images=[
 "https://raw.githubusercontent.com/etkyogya-hub/cbtlearning-snbt-1/main/videos/assets/Qz1.jpg",
 "https://raw.githubusercontent.com/etkyogya-hub/cbtlearning-snbt-1/main/videos/assets/Qz2.jpg",
 "https://raw.githubusercontent.com/etkyogya-hub/cbtlearning-snbt-1/main/videos/assets/Qz3.jpg"
];

const rationale=document.getElementById("rationale");
const image=document.getElementById("image");
const quiz=document.getElementById("quizText");
const cascade=document.getElementById("cascade");
const fly=document.getElementById("fly");

let idx=0;
const DURATION=5200;

/* preload images */
images.forEach(src=>{ const i=new Image(); i.src=src; });

/* split words for fly animation */
function splitWords(){
  quiz.innerHTML = quiz.dataset.text.split(" ")
    .map(w=>`<span>${w}</span>`).join(" ");
}

/* fly words animation */
function flyWords(){
  fly.innerHTML="";
  const pRect = fly.getBoundingClientRect();
  quiz.querySelectorAll("span").forEach((s,i)=>{
    const r=s.getBoundingClientRect();
    const c=s.cloneNode(true);
    c.className="word-fly";
    c.style.left = r.left - pRect.left + "px";
    c.style.top  = r.top - pRect.top + "px";
    fly.appendChild(c);
    setTimeout(()=>{
      const a=Math.random()*Math.PI*2;
      c.style.transform = `translate(${Math.cos(a)*80}px,${Math.sin(a)*80}px) scale(1.8)`;
      c.classList.add("out");
    }, i*120);
    setTimeout(()=>c.remove(), 1600);
  });
}

/* cascade animation */
function showCascade(){
  cascade.innerHTML="";
  images.forEach((src,i)=>{
    const img=document.createElement("img");
    img.src=src;
    img.style.zIndex=10+i;
    cascade.appendChild(img);
    setTimeout(()=>{
      img.style.opacity=1;
      img.style.transform=`translateY(${i*28}px) scale(1)`;
    }, i*260);
    setTimeout(()=>img.remove(), DURATION);
  });
}

/* wait for image to load */
function loadImage(src){
  return new Promise(res=>{
    image.src=src;
    if(image.complete) res();
    else image.onload = res;
  });
}

/* main loop */
async function showLoop(){
  while(true){
    const current = idx % images.length;
    await loadImage(images[current]);
    idx++;

    rationale.classList.remove("show");
    quiz.classList.remove("show");
    quiz.innerHTML = quiz.dataset.text;

    // show rationale
    setTimeout(()=> rationale.classList.add("show"), 200);

    // show quiz and fly words
    setTimeout(()=>{
      quiz.classList.add("show");
      splitWords();
      flyWords();
    }, 900);

    // show cascade slightly before hiding rationale
    setTimeout(()=> showCascade(), DURATION - 1400);

    // hide rationale & quiz after duration
    await new Promise(res=>setTimeout(()=>{
      rationale.classList.remove("show");
      quiz.classList.remove("show");
      res();
    }, DURATION));
  }
}

showLoop();
</script>
